#pragma once
#include <vector>
#include <Eigen/Dense>
#include <mass_properties.hpp>
using namespace mahi::util;

inline Eigen::MatrixXd get_M(const std::vector<double>& qs){
	Eigen::MatrixXd M = Eigen::MatrixXd::Zero(4,4); 

	const double q0 = qs[0];
	const double q1 = qs[1];
	const double q2 = qs[2];
	const double q3 = qs[3];
	const double qd0 = qs[4];
	const double qd1 = qs[5];
	const double qd2 = qs[6];
	const double qd3 = qs[7];

	const double t2 = cos(q1);
	const double t3 = cos(q2);
	const double t4 = cos(q3);
	const double t5 = sin(q1);
	const double t6 = sin(q2);
	const double t7 = sin(q3);
	const double t8 = Pcx1*Pcx1;
	const double t9 = Pcx2*Pcx2;
	const double t10 = Pcx3*Pcx3;
	const double t11 = Pcy1*Pcy1;
	const double t12 = Pcy2*Pcy2;
	const double t13 = Pcy3*Pcy3;
	const double t14 = Pcz2*Pcz2;
	const double t15 = Pcz3*Pcz3;
	const double t16 = q1*2.0;
	const double t17 = q2*2.0;
	const double t18 = q3*2.0;
	const double t19 = t2*t2;
	const double t20 = t3*t3;
	const double t21 = t4*t4;
	const double t22 = sin(t16);
	const double t23 = sin(t17);
	const double t24 = sin(t18);
	const double t25 = Icxy2*t2;
	const double t26 = Icxz1*t2;
	const double t27 = Icxy3*t3;
	const double t28 = Icxz2*t3;
	const double t29 = Icyz3*t4;
	const double t30 = Icxx3*t5;
	const double t31 = Icxz3*t7;
	const double t32 = Icyz1*t5;
	const double t33 = Icyz2*t6;
	const double t34 = Iczz2*t5;
	const double t35 = Iczz3*t6;
	const double t36 = m1*t8;
	const double t37 = m2*t9;
	const double t38 = m3*t10;
	const double t39 = m2*t12;
	const double t40 = m3*t13;
	const double t41 = m3*t15;
	const double t42 = Pcx2*Pcy2*m2*t2;
	const double t43 = Pcx3*Pcy3*m3*t3;
	const double t44 = Pcx1*Pcz1*m1*t2;
	const double t45 = Pcx2*Pcz2*m2*t3;
	const double t46 = Pcy3*Pcz3*m3*t4;
	const double t47 = Pcx3*Pcz3*m3*t7;
	const double t48 = Pcy1*Pcz1*m1*t5;
	const double t49 = Pcy2*Pcz2*m2*t6;
	const double t50 = Icxz3*t2*t4;
	const double t51 = Icxz3*t3*t4;
	const double t52 = Icyz2*t2*t3;
	const double t53 = Iczz3*t2*t3;
	const double t54 = Icxy3*t2*t6;
	const double t56 = Icxz2*t2*t6;
	const double t58 = Icyz3*t2*t7;
	const double t60 = Icyz3*t3*t7;
	const double t80 = Pcx3*Pcz3*m3*t2*t4;
	const double t81 = Pcx3*Pcz3*m3*t3*t4;
	const double t82 = Pcy2*Pcz2*m2*t2*t3;
	const double t83 = Pcx3*Pcy3*m3*t2*t6;
	const double t85 = Pcx2*Pcz2*m2*t2*t6;
	const double t87 = Pcy3*Pcz3*m3*t2*t7;
	const double t89 = Pcy3*Pcz3*m3*t3*t7;
	const double t95 = Icxx2*t2*t3*t6;
	const double t96 = Icxx3*t3*t4*t7;
	const double t99 = Icyy2*t2*t3*t6;
	const double t100 = Icyy3*t2*t3*t6;
	const double t101 = Icyy3*t3*t4*t7;
	const double t126 = Icxy3*t4*t5*t7*2.0;
	const double t142 = Icxx3*t2*t4*t6*t7;
	const double t144 = Icyy3*t2*t4*t6*t7;
	const double t170 = Pcx3*Pcy3*m3*t4*t5*t7*2.0;
	const double t211 = Pcx1*m1*t2*2.8024836E-1;
	const double t212 = Pcy1*m1*t5*2.8024836E-1;
	const double t213 = Pcz2*m2*t5*2.8024836E-1;
	const double t216 = Pcx3*m3*t2*t4*2.8024836E-1;
	const double t217 = Pcy2*m2*t2*t3*2.8024836E-1;
	const double t218 = Pcz3*m3*t2*t3*2.8024836E-1;
	const double t219 = Pcx2*m2*t2*t6*2.8024836E-1;
	const double t220 = Pcx2*m2*t3*t5*2.8024836E-1;
	const double t221 = Pcy3*m3*t2*t7*2.8024836E-1;
	const double t222 = Pcy3*m3*t4*t5*2.8024836E-1;
	const double t223 = Pcx3*m3*t5*t7*2.8024836E-1;
	const double t224 = Pcy2*m2*t5*t6*2.8024836E-1;
	const double t225 = Pcz3*m3*t5*t6*2.8024836E-1;
	const double t230 = Pcx3*m3*t3*t4*t5*2.8024836E-1;
	const double t232 = Pcy3*m3*t3*t5*t7*2.8024836E-1;
	const double t235 = Pcy3*m3*t2*t6*t7*(-2.8024836E-1);
	const double t237 = Pcy3*m3*t4*t5*t6*(-2.8024836E-1);
	const double t238 = Pcx3*m3*t5*t6*t7*(-2.8024836E-1);
	const double t55 = t5*t27;
	const double t57 = t5*t28;
	const double t59 = t5*t29;
	const double t61 = t6*t29;
	const double t62 = t5*t31;
	const double t63 = t6*t31;
	const double t64 = t5*t33;
	const double t65 = -t27;
	const double t66 = -t28;
	const double t67 = -t30;
	const double t68 = -t32;
	const double t69 = -t34;
	const double t70 = -t35;
	const double t71 = Icxx3*t21;
	const double t72 = Icyy3*t21;
	const double t73 = Icxy3*t24;
	const double t74 = t5*t37;
	const double t75 = t6*t38;
	const double t76 = t5*t39;
	const double t77 = t5*t40;
	const double t78 = t6*t40;
	const double t79 = t5*t41;
	const double t84 = t5*t43;
	const double t86 = t5*t45;
	const double t88 = t5*t46;
	const double t90 = t6*t46;
	const double t91 = t2*t3*t29;
	const double t92 = t5*t47;
	const double t93 = t6*t47;
	const double t94 = t5*t49;
	const double t97 = t2*t3*t31;
	const double t98 = t6*t50;
	const double t102 = t2*t3*t35;
	const double t103 = -t43;
	const double t104 = -t45;
	const double t105 = t6*t58;
	const double t107 = -t48;
	const double t108 = -t51;
	const double t109 = -t52;
	const double t111 = -t54;
	const double t112 = -t56;
	const double t113 = -t58;
	const double t119 = Pcx3*Pcy3*m3*t24;
	const double t120 = t21*t30;
	const double t124 = t2*t3*t38;
	const double t125 = t2*t3*t40;
	const double t133 = t21*t38;
	const double t134 = t21*t40;
	const double t135 = t20*t25*2.0;
	const double t136 = t21*t27*2.0;
	const double t137 = t6*t87;
	const double t139 = -t81;
	const double t140 = -t82;
	const double t143 = t3*t4*t7*t30;
	const double t145 = t5*t101;
	const double t146 = -t83;
	const double t147 = -t85;
	const double t148 = -t87;
	const double t154 = -t96;
	const double t156 = -t99;
	const double t161 = t2*t3*t46;
	const double t162 = t2*t3*t47;
	const double t163 = t6*t80;
	const double t164 = t2*t3*t6*t37;
	const double t165 = t3*t4*t7*t38;
	const double t166 = t2*t3*t6*t39;
	const double t168 = t3*t4*t7*t40;
	const double t169 = t2*t3*t6*t41;
	const double t171 = t20*t42*2.0;
	const double t172 = t21*t43*2.0;
	const double t173 = t20*t50*2.0;
	const double t176 = t21*t54*2.0;
	const double t178 = t20*t58*2.0;
	const double t180 = -t142;
	const double t191 = t20*t80*2.0;
	const double t192 = t21*t83*2.0;
	const double t194 = t20*t87*2.0;
	const double t200 = t2*t4*t6*t7*t27*2.0;
	const double t206 = t2*t4*t6*t7*t43*2.0;
	const double t210 = t29+t31+t46+t47;
	const double t214 = -t211;
	const double t215 = -t213;
	const double t226 = -t216;
	const double t227 = -t224;
	const double t228 = -t225;
	const double t229 = t6*t216;
	const double t231 = t6*t221;
	const double t233 = t6*t222;
	const double t234 = t6*t223;
	const double t236 = -t232;
	const double t106 = t6*t59;
	const double t110 = t6*t62;
	const double t114 = -t59;
	const double t115 = -t61;
	const double t116 = -t62;
	const double t117 = -t63;
	const double t118 = -t64;
	const double t121 = t5*t72;
	const double t122 = -t71;
	const double t123 = -t73;
	const double t127 = -t74;
	const double t128 = -t75;
	const double t129 = -t76;
	const double t130 = -t77;
	const double t131 = -t78;
	const double t132 = -t79;
	const double t138 = t6*t88;
	const double t141 = t6*t92;
	const double t149 = -t88;
	const double t150 = -t90;
	const double t151 = -t92;
	const double t152 = -t93;
	const double t153 = -t94;
	const double t155 = -t98;
	const double t157 = t2*t3*t70;
	const double t158 = -t119;
	const double t159 = -t135;
	const double t167 = t2*t3*t78;
	const double t174 = t5*t133;
	const double t175 = t21*t77;
	const double t177 = t21*t55*2.0;
	const double t179 = -t134;
	const double t181 = -t145;
	const double t182 = t2*t3*t6*t71;
	const double t183 = t2*t3*t6*t72;
	const double t184 = -t171;
	const double t185 = -t173;
	const double t187 = -t163;
	const double t188 = -t164;
	const double t190 = -t168;
	const double t193 = t21*t84*2.0;
	const double t196 = t2*t4*t7*t75;
	const double t197 = t5*t165;
	const double t198 = t2*t4*t7*t78;
	const double t199 = t3*t4*t7*t77;
	const double t201 = -t191;
	const double t204 = t2*t3*t21*t75;
	const double t160 = -t121;
	const double t186 = -t177;
	const double t189 = t2*t3*t131;
	const double t195 = -t174;
	const double t202 = -t193;
	const double t203 = -t183;
	const double t205 = t21*t167;
	const double t207 = -t197;
	const double t208 = t2*t4*t7*t131;
	const double t209 = t2*t3*t21*t128;
	const double t239 = t60+t70+t89+t108+t128+t131+t139;
	const double t240 = t33+t49+t65+t66+t101+t103+t104+t115+t117+t136+t150+t152+t154+t165+t172+t190;
	const double t241 = t53+t105+t114+t116+t124+t125+t137+t149+t151+t155+t187+t221+t226+t237+t238;
	const double t242 = t67+t69+t91+t97+t109+t111+t112+t120+t126+t127+t129+t130+t132+t140+t144+t146+t147+t160+t161+t162+t170+t175+t176+t180+t192+t195+t196+t208+t220+t227+t228+t230+t236;
	const double t243 = t25+t26+t42+t44+t50+t55+t57+t68+t80+t84+t86+t95+t100+t106+t107+t110+t113+t118+t138+t141+t143+t148+t153+t156+t157+t159+t166+t169+t178+t181+t182+t184+t185+t186+t188+t189+t194+t199+t200+t201+t202+t203+t205+t206+t207+t209+t212+t214+t215+t217+t218+t219+t222+t223+t229+t235;
	M(0,0) = Icxx3+Icyy1+Iczz0+Iczz2+m1*7.853914328268959E-2+m2*7.853914328268959E-2+m3*7.853914328268959E-2+t36+t37+t39+t40+t41+t72+t122+t123+t133+t158+t179+Icxx1*t19+Icxx2*t19-Icxx3*t19+Icxy1*t22-Icyy1*t19+Icyy3*t19-Pcz1*m1*5.604967199999999E-1-Iczz2*t19-t19*t36-t19*t37+t5*t52*2.0+t19*t38+t5*t54*2.0-t19*t40+t5*t56*2.0+t5*t82*2.0+t5*t83*2.0+t5*t85*2.0+t19*t71*2.0-t19*t72*2.0-t5*t144*2.0-t19*t133*2.0+t19*t134*2.0-t5*t196*2.0+(Pcx0*Pcx0)*m0+(Pcy0*Pcy0)*m0+(Pcz1*Pcz1)*m1-Pcx2*m2*t3*5.604967199999999E-1-Icxx2*t19*t20+Pcy2*m2*t6*5.604967199999999E-1+Icyy2*t19*t20-Icyy3*t19*t20+Pcz3*m3*t6*5.604967199999999E-1+Iczz3*t19*t20+m1*t11*t19+m2*t14*t19-t2*t3*t59*2.0-t2*t3*t62*2.0-t6*t19*t51*2.0+t19*t20*t37-t19*t20*t39+t19*t20*t40-t5*t21*t54*4.0-t19*t20*t41+t6*t19*t60*2.0-t2*t3*t88*2.0-t2*t3*t92*2.0-t6*t19*t81*2.0-t5*t21*t83*4.0+t19*t20*t72+t6*t19*t89*2.0+t19*t20*t122+t19*t20*t133+t19*t20*t179-Pcx3*m3*t3*t4*5.604967199999999E-1-Icxy2*t3*t6*t19*2.0+Icxy3*t4*t7*t19*4.0+Pcy3*m3*t3*t7*5.604967199999999E-1+Pcx1*Pcy1*m1*t22-Icxy3*t4*t7*t19*t20*2.0+t2*t4*t6*t7*t30*2.0+t2*t4*t6*t7*t77*2.0-Pcx2*Pcy2*m2*t3*t6*t19*2.0+Pcx3*Pcy3*m3*t4*t7*t19*4.0-Pcx3*Pcy3*m3*t4*t7*t19*t20*2.0;
	M(0,1) = t243;
	M(0,2) = t242;
	M(0,3) = t241;
	M(1,0) = t243;
	M(1,1) = Icyy2+Iczz1+Iczz3+t36+t37+t38+t40+Icxx2*t20+Icxy2*t23-Icyy2*t20+Icyy3*t20-Iczz3*t20+m1*t11+m2*t14+t6*t51*2.0-t20*t37+t20*t39-t20*t40+t20*t41-t6*t60*2.0+t6*t81*2.0+t20*t71-t20*t72-t6*t89*2.0-t20*t133+t20*t134+Icxy3*t4*t7*t20*2.0+Pcx2*Pcy2*m2*t23+Pcx3*Pcy3*m3*t4*t7*t20*2.0;
	M(1,2) = t240;
	M(1,3) = t239;
	M(2,0) = t242;
	M(2,1) = t240;
	M(2,2) = Icxx3+Iczz2+t37+t39+t40+t41+t72+t122+t123+t133+t158+t179;
	M(2,3) = t210;
	M(3,0) = t241;
	M(3,1) = t239;
	M(3,2) = t210;
	M(3,3) = Iczz3+t38+t40;

	return M;
}